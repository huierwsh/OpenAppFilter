name: Compile OpenAppFilter for OpenWrt 24.10 (iStoreOS 24.10.5)

# 触发条件：推送代码/手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-22.04  # 稳定编译环境
    steps:
      # 1. 安装基础编译依赖
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip \
            python3-distutils rsync curl flex bison libpcap-dev libiptc-dev

      # 2. 下载 OpenWrt 24.10 官方 SDK（x86_64，适配iStoreOS 24.10.5）
      - name: Download OpenWrt 24.10.5 SDK (x86_64)
        run: |
          # OpenWrt 24.10 x86_64 官方SDK（长期有效）
          SDK_URL="https://downloads.openwrt.org/releases/24.10.5/targets/x86/64/openwrt-sdk-24.10.5-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          # 安装 zstd（解压 .zst 格式需）+ 增加 3 次重试 + 跳过证书校验
          sudo apt install -y zstd
          wget -O openwrt-sdk.tar.zst $SDK_URL --no-check-certificate --tries=3 --wait=5
          # 下载并解压SDK
          # wget -O openwrt-sdk.tar.xz $SDK_URL --no-check-certificate
          mkdir -p openwrt-sdk
          tar -xzf openwrt-sdk.tar.zst -C openwrt-sdk --strip-components=1

      # 3. 拉取你的 OpenAppFilter 代码
      - name: Clone your OpenAppFilter repo
        run: |
          cd openwrt-sdk
          git clone https://github.com/huierwsh/OpenAppFilter package/OpenAppFilter

      # 4. 配置并编译插件（仅编译OpenAppFilter，提速）
      - name: Compile OpenAppFilter plugin
        run: |
          cd openwrt-sdk
          # 加载默认配置
          make defconfig
          # 仅编译OpenAppFilter，V=s显示详细日志（排错用）
          make package/OpenAppFilter/compile V=s

      # 5. 上传编译好的ipk文件（可直接下载使用）
      - name: Upload compiled IPK
        uses: actions/upload-artifact@v4
        with:
          name: openappfilter-ipk-x86_64
          path: |
            openwrt-sdk/bin/packages/x86_64/*/openappfilter*.ipk
            openwrt-sdk/bin/packages/x86_64/*/luci-app-oaf*.ipk
